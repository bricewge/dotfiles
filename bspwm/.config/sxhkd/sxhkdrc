# -*- mode: conf-space -*-
# keybindings for bspwm

# TODO unhide a window from rofi
# TODO add preselection
# TODO polish picture-in-picture
# TODO Setup dynamic desktops

# * bspwm hotkeys
# ** general
# Close or kill a window
super + {_, shift +} d
  bspc node --{close,kill}

# ** set properties
# Change window's state
super + s ; {t,p,f,F}
  state={tiled,pseudo_tiled,floating,fullscreen}; \
  bspc node --state "~$state"
# Toggle window's flag
super + f ; {h,s,p,l,m,u}
  flag={hidden,sticky,private,locked,marked,urgent}; \
  bspc node --flag "$flag"
# Change window's layer
super + y ; {b,n,a}
  bspc node --layer {below, normal, above}

# ** monitor
# Cycle through monitors
super + {q,w}
  bspc monitor --focus {next,prev}

# Move window or desktop to monitor
super + {shift,alt} + {q,w}
  bspc {node,desktop} --to-monitor {next,prev}

# Switch between monitors
super + alt + {1-9}
  bspc monitor --focus '^'{1-9}

# ** resize
# Increase window's size from a side
super + z: {h,j,k,l}
  bspc node --resize {left -20 0, bottom 0 20, top 0 -20, right 20 0}
# Decrease window's size from a side
super + z: shift + {h,j,k,l}
  bspc node --resize {left 20 0, bottom 0 -20, top 0 20, right -20 0}

# ** movements
# Activate window or move it to current desktop
super + {_,shift + }{h,j,k,l}
  bspc node --{focus,swap} {west,south,north,east}

# Cycle through desktops
super + ctrl + {h,l}
  bspc desktop --focus {prev,next}

# Switch to a desktop within a monitor
super + {1-9}
  bspc desktop --focus 'focused:^'{1-9}

# Send the selected window to the desktop 1-6 and follow it, if no
# window is selected go to the desktop 1-6 anyway.
super + shift + {1-9}
  bspc node focused --to-desktop 'focused:^'{1-9} --follow
# Go to the next or previous desktop
super + {Left, comma, Right, period}
  bspc desktop -f {prev,prev,next,next}
# Move the selected window to the next or previous desktop
super + shift + {Left,Right}
  dir={prev,next} && \
  bspc node --to-desktop "$dir" --follow

# Switch between the last node/monitor
super + {_, shift +} Tab
  bspc {node,monitor} -f last

# ** mouse
~button1
  bspc node pointed -f

# ** exotic
# Swap window with the biggest one
super + m
  bspc node focused --swap biggest.local

# Toogle windows gap
super + g
  gap=$(test $(bspc config -d focused window_gap) -eq $\{BSPWM_GAP:=20\} \
        && echo 0 || echo $BSPWM_GAP ) && \
  bspc config -d focused window_gap $gap

# Increase or reduce the gap between windows
super + G: super {g,G}
  bspc config -d focused window_gap "$(($(bspc config -d focused window_gap) {-,+} 5 ))"

# Rotate the tree clockwise and counter-clockwise
super + {_, shift +} r
  bspc node @/ --rotate {+,-}90

# Flip the current desktop horizontaly or verticaly
super + {i,I}
  bspc node @/ --flip {horizontal, vertical}

# *** opacity
# Increase/decrase window's transparency
super + o: {o, O}
  compton-trans -c -o {+,-}5

# *** picture in picture
# Picture-in-picutre mode
super + p
  compton-trans -c -o 75 && \
  bspc node --state floating --flag sticky && \
  xdotool getactivewindow windowsize  700 400 windowmove 1100 600

# * app launchers
# Stop the key chain if the mouse buttons are pressed
super + space ; ~button{1,2,3}
  echo button{1,2,3} stoped key chain

# Terminal
super + space ; {t, T}
  alacritty --command tmux {new-session -t main,_}

# TODO Should open a clean emacs
# Text editor
super + space ; {e, E}
  {emacsclient -nc -a "", emacs}

# TODO Add ranger.el
# File browser
super + space ; f
  nautilus

# Web browser
super + space ; {w, W}
  {firefox,chromium}

# Video player
super + space ; v
  mpv --profile=pseudo-gui

# List applications
super + space ; space
  rofi -show drun

# * Â¿ interface ?
# List sxhkd key bindings
super + space ; h
  rofi-sxhkd

# Password manager
super + space ; p
  rofi-pass

# WiFi menu
super + space ; n
  rofi-wifi

# TODO Test this
# List ?disks?
super + space; u
  UDISKIE_DMENU_LAUNCHER=rofi udiskie-dmenu -matching regex -dmenu -i -no-custom -multi-select

# Capture note
super + space ; o
  org-capture

# super + 0
#   xdotool search --onlyvisible --name TermiteDropDown windowunmap \
#       || xdotool search --name TermiteDropdown windowmap \
#       || termite --name TermiteDropdown --geometry=`xdotool getdisplaygeometry | awk '{ print $1"x"$2/3 }'`

# super + =
#     id=$(bspc query -N -n "focused");\
#     if [ -n "$id" ];then \
#         xprop -id $id -f _SCRATCH 32ii -set _SCRATCH $(date +%s,%N);\
#         bspc node -t "floating";\
#         xdotool windowunmap $id;\
#     fi

# ** screenshot
# Take a screenshot of all desktops
super + space ; s
  screenshot  ~/picture/screenshot/$(date --iso-8601=seconds).png

# Take screenshot of a window
super + space ; S
  screenshot --select --tolerance 9999999 --hidecursor --nokeyboard \
  ~/picture/screenshot/$(date --iso-8601=seconds).png

# ** TODO notifications
# * macOS shortcuts

# For selection, copy and paste. Thanks to:
# http://developers-club.com/posts/266375/

# copy
# super + c
#   copypaste.sh copy
# # paste
# super + v
#   copypaste.sh paste
# # cut
# super + x
#   xvkbd -xsendevent -text '\[Control_L]x'
# # select all
# super + a
#   xvkbd -xsendevent -text '\[Control_L]a'

# * media keys
# ** monitor brightness
{super + F1, XF86MonBrightnessDown}
  xbacklight -ctrl intel_backlight -dec 12; \
  xbacklight -ctrl ddcci4 -dec 12

{super + F2, XF86MonBrightnessUp}
  xbacklight -ctrl intel_backlight -inc 12; \
  xbacklight -ctrl ddcci4 -inc 12

# ** TODO launchers
{super + F3, XF86LaunchA, super + bracketleft}
  dropdown.sh

{super + F4, XF86LaunchB, super + bracketright}
  riseup.sh

# ** keyboard brightness
XF86KbdBrightnessDown
  xbacklight -fps 10 -ctrl smc::kbd_backlight -7

XF86KbdBrightnessUp
  xbacklight -fps 10 -ctrl smc::kbd_backlight +7

# ** multimedia
{super + F7, XF86AudioPrev}
  mpvc previous || playerctl previous

{super + F8, XF86AudioPlay}
  mpvc toggle || playerctl play-pause

{super + F9, XF86AudioNext}
  mpvc next || playerctl next

# ** audio volume
{super + F10, XF86AudioMute}
  pactl set-sink-mute @DEFAULT_SINK@ toggle

{super + F11, XF86AudioLowerVolume}
  pactl set-sink-volume @DEFAULT_SINK@ -5% && \
  pactl set-sink-mute @DEFAULT_SINK@ 0

{super + F12, XF86AudioRaiseVolume}
  pactl set-sink-volume @DEFAULT_SINK@ +5% && \
  pactl set-sink-mute @DEFAULT_SINK@ 0

XF86AudioMicMute
  pactl set-source-mute @DEFAULT_SOURCE@ toggle

# ** system
{super + space; p, XF86PowerOff}
  rofi-power "bspc quit 1"

# * window manager
# Reload UI configurations
super + Escape
  pkill -USR1 -x "(sxhkd|compton)" && \
  notify-send -u low "sxhkd reloaded"

# Quit bspwm and kill the panel
super + alt + Escape
  pkill conky; pkill polybar; bspc quit

# ~Escape
#   ~/.config/bspwm/panel/scripts/toggle_conky *

# * workarounds
# Disable Ctrl+q for Firefox
# ctrl + q
#   notify-send "ctrl+q pressed" ;\
#   xdo key_press -k 105 ; sleep 0.2 ;\
#   xdo key_press -k 24 ; sleep 0.2 ;\
#   xdo key_release -k 24 ; sleep 0.2 ;\
#   xdo key_release -k 105
